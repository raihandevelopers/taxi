import{_ as X,C as $,r as p,aj as ee,D as se,a as D,a6 as te,Z as oe,ak as ae,al as ie,g as y,S as ne,o as r,x as V,w as c,U as O,l as e,i as l,J as _,q as N,k as u,M as G,B as k,L as A,F as Y,p as Q,y as J,n as re}from"./vendor-ddfbd976.js";import{L as le}from"./main-306a5ea6.js";import"./footer-e648049d.js";import"./app-042fb454.js";const ce=""+new URL("avatar-2-52cb265f.jpg",import.meta.url).href,de={props:{conversations:Array,firebaseConfig:Object,selectedConversationId:Object},setup(b){$();const t=p(b.conversations),T=p([]),o=p({message:""}),h=p(b.selectedConversationId??null),R=p(""),C=p(ce),w=ee(),j=async a=>{try{const i=await D.get(`/chat/messages/${a}`);T.value=i.data;const n=t.value.find(m=>m.id===a);n.unread=0,B("users-chat")}catch(i){console.error("Error fetching messages:",i)}},B=a=>{setTimeout(()=>{const i=document.getElementById(a).querySelector("#chat-conversation .simplebar-content-wrapper"),n=document.getElementsByClassName("chat-conversation-list")[0].scrollHeight-window.innerHeight+600;n&&i.scrollTo({top:n,behavior:"smooth"})},300)},x=p(!1),E=p(!1),M=p(""),f=p([]),U=async()=>{const a=M.value.trim();if(a.length>2)try{const i=await D.get(`/chat/search-user?search=${a}`);f.value=i.data.data}catch(i){f.value=[],console.log("no users found"),console.error(i)}else f.value=[]},q=async()=>{E.value=!E.value,M.value.length>0&&(M.value=""),f.value.length>0&&(f.value=[])},s=async a=>{try{const n=(await D.post("/chat/createChat",{user_id:a.id})).data,m=new Date(n.created_at),v=S(m);if(n){let d={id:n.id,unread:0,subject:n.subject,role:a.role_name,profile_picture:n.profile_picture,last_message_time:v};t.value.unshift(d),await z(n.id)}q()}catch(i){f.value=[],console.log("no users found"),console.error(i)}};function S(a){const i={day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit",hour12:!0};return a.toLocaleString("en-GB",i).replace(",","")}const F=async a=>{if(a&&a.preventDefault(),w.value.$touch(),w.value.$invalid||x.value)return;x.value=!0;const i=o.value.message,n=new Date,m=(n.getHours()<10?"0":"")+n.getHours(),v=(n.getMinutes()<10?"0":"")+n.getMinutes(),d={align:"right",message:i,time:`${m}:${v}`,conversationId:h.value};try{await D.post("/chat/send-admin",d),o.value.message="",await j(h.value),B("users-chat")}catch(g){console.error("Error sending message:",g)}finally{x.value=!1}},z=async a=>{h.value=a;const i=t.value.find(n=>n.id===a);i&&(R.value=i.subject,C.value=i.profile_picture),await j(a)},W=()=>{const a=O.mixin({customClass:{confirmButton:"btn btn-success me-2",cancelButton:"btn btn-danger ml-2"},buttonsStyling:!1});a.fire({title:"Are you sure?",text:"You need to close this chat!",icon:"warning",confirmButtonText:"Yes, close it!",cancelButtonText:"No, cancel!",showCancelButton:!0}).then(async i=>{if(i.isConfirmed)try{await D.post("/chat/close-chat",{conversationId:h.value}),t.value=t.value.filter(n=>n.id!==h.value),a.fire("Closed!","Your chat has been closed.","success"),h.value=null,T.value=[]}catch(n){console.error(n),a.fire("Error!","There was a problem closing the chat.","error")}else i.dismiss===O.DismissReason.cancel&&a.fire("Cancelled","Your chat conversation is safe :)","error")})},Z=a=>{if(a){const i=new Date(a),n=i.getHours().toString().padStart(2,"0"),m=i.getMinutes().toString().padStart(2,"0");return`${n}:${m}`}return""},K=async a=>{try{return(await D.get(`/chat/fetch-user?user_id=${a}`)).data}catch(i){console.error(i)}};return se(async()=>{try{h.value&&await z(h.value);const a=b.firebaseConfig;firebase.apps.length||firebase.initializeApp(a);const i=firebase.database().ref("conversation");let n=!1;t.value.forEach(m=>{m.last_message_time=S(new Date(m.last_message_time))}),t.value.forEach(m=>{i.child(m.id).on("value",async function(v){const d=v.val();if(n&&d&&d.sender_type!=="admin")if(d.conversation_id==h.value){const g=new Date(d.created_at),I=S(g);let L={id:d.message_id,align:"left",message:d.message,profile_picture:C.value,time:I};T.value.push(L),B("users-chat")}else{let g=t.value.find(I=>I.id===d.conversation_id);g?(g.unread=parseInt(g.unread)+1,g.last_message_time=S(new Date(d.created_at))):console.error("Conversation not found!")}})}),setTimeout(function(){n=!0},2e3),i.on("child_added",async function(m){if(n){const v=m.val(),d=await K(v.sender_id),g=new Date(v.created_at),I=S(g);if(v.conversation_id==h.value){let L={id:v.message_id,align:"left",role:d.name,message:d.name,profile_picture:d.profile_picture,time:I};T.value.push(L),B("users-chat")}else try{const H=(await D.get(`/chat/verify-chat?conversationId=${v.conversation_id}`)).data.data;if(H){let P={id:H.id,unread:1,subject:H.subject,role:d.role_name,profile_picture:H.profile_picture,last_message_time:I};t.value.unshift(P)}}catch(L){console.log("no conversation found"),console.error(L)}}})}catch(a){console.error(a)}}),{v$:w,form:o,conversationsData:t,messagesData:T,formSubmit:F,isSubmitting:x,selectedConversationId:h,scrollToBottom:B,convertedTime:Z,selectConversation:z,username:R,profile:C,cancel:W,userSearch:E,toggleSearch:q,searchQuery:M,users:f,onSearch:U,createChat:s}},components:{Layout:le,simplebar:te,Head:oe},validations:{form:{message:{required:ae.withMessage("Message is required",ie)}}}},ue={class:"chat-wrapper d-lg-flex gap-1 mx-n4 mt-n4 p-1"},_e={class:"chat-leftsidebar"},me={class:"px-4 pt-4 mb-4"},he={class:"d-flex align-items-center gap-4"},ve={key:0,class:"flex-grow-1"},fe={class:"mb-0"},ge={key:1,class:"flex-grow-1"},pe={class:"mb-0"},be={key:2,class:"flex-shrink-0"},xe={title:"Add Contact"},ye={key:3,class:"flex-shrink-0"},we={title:"Cancel"},ke={key:4,class:"dropdown-menu-xl"},Ce={class:"search-box position-relative"},Be={class:"d-flex align-items-center px-4 mb-2"},Se={class:"flex-grow-1"},De={class:"mb-0 fs-11 text-muted text-uppercase"},Te={class:"chat-message-list"},je={class:"list-unstyled chat-list chat-user-list"},Me=["onClick"],Ie={class:"d-flex align-items-center"},Le={class:"flex-shrink-0 chat-user-img online align-self-center me-2 ms-0"},Ee={key:0,class:"avatar-xxs avatar-xs"},qe=["src"],He={key:1,class:"avatar-xxs avatar-xs"},Ve={class:"avatar-title rounded-circle bg-danger userprofile avatar-xs"},Ne={class:"flex-grow-1 overflow-hidden"},Re={class:"text-truncate mb-1"},Ue={class:"text-muted mb-1"},ze={class:"d-flex align-items-center px-4 mb-2"},Ae={class:"flex-grow-1"},Ye={class:"mb-0 fs-11 text-muted text-uppercase"},Qe={class:"chat-message-list"},Fe={class:"list-unstyled chat-list chat-user-list"},Oe=["onClick"],Ge={class:"d-flex align-items-center"},Je={class:"flex-shrink-0 chat-user-img online align-self-center me-2 ms-0"},We={key:0,class:"avatar-xxs avatar-xs"},Ze=["src"],Ke={key:1,class:"avatar-xxs avatar-xs"},Pe={class:"avatar-title rounded-circle bg-danger userprofile avatar-xs"},Xe={class:"flex-grow-1 overflow-hidden"},$e={class:"text-truncate mb-1"},es={class:"text-muted mb-1"},ss={class:"d-flex align-items-center"},ts={key:0,class:"position-absolute translate-middle badge border border-light rounded-circle bg-success p-1"},os={class:"flex-shrink-0"},as={class:"user-chat w-100 overflow-hidden"},is={class:"chat-content d-lg-flex"},ns={class:"w-100 overflow-hidden position-relative"},rs={key:0,class:"position-relative"},ls={class:"p-3 user-chat-topbar"},cs={class:"d-flex align-items-center"},ds={class:"flex-shrink-0 d-block d-lg-none me-3"},us={class:"flex-grow-1 overflow-hidden"},_s={class:"d-flex align-items-center"},ms={class:"flex-shrink-0 chat-user-img online user-own-img align-self-center me-3 ms-0"},hs=["src"],vs={class:"flex-grow-1 overflow-hidden"},fs={class:"text-truncate mb-0 fs-16"},gs={class:"list-inline user-chat-nav text-end mb-0"},ps={class:"list-inline-item m-0"},bs={class:"position-relative",id:"users-chat"},xs={class:"list-unstyled chat-conversation-list"},ys={class:"conversation-list d-flex align-items-center"},ws={key:0,class:"chat-avatar"},ks=["src"],Cs={class:"user-chat-content"},Bs={class:"ctext-wrap"},Ss={class:"ctext-wrap-content"},Ds={class:"mb-0 ctext-content"},Ts={class:"conversation-name"},js={class:"text-muted time"},Ms={class:"chat-input-section p-3 p-lg-4"},Is=["disabled","placeholder"],Ls={class:"chat-input-links ms-2"},Es={class:"links-list-item"},qs={key:0,class:"ri-send-plane-2-fill align-bottom"},Hs={key:1,class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},Vs={key:1,class:"position-relative"};function Ns(b,t,T,o,h,R){const C=y("BButton"),w=y("BLink"),j=y("simplebar"),B=y("BBadge"),x=y("BCol"),E=y("BDropdownItem"),M=y("BDropdown"),f=y("BRow"),U=y("Layout"),q=ne("b-tooltip");return r(),V(U,null,{default:c(()=>[e("div",ue,[e("div",_e,[e("div",me,[e("div",he,[o.userSearch?(r(),l("div",ge,[e("h5",pe,_(b.$t("users")),1)])):(r(),l("div",ve,[e("h5",fe,_(b.$t("chats")),1)])),o.userSearch?(r(),l("div",ye,[N((r(),l("div",we,[u(C,{type:"button",onClick:o.toggleSearch,variant:"soft-success",size:"sm"},{default:c(()=>t[6]||(t[6]=[e("i",{class:"ri-close-line align-bottom"},null,-1)])),_:1,__:[6]},8,["onClick"])])),[[q,void 0,void 0,{hover:!0}]])])):(r(),l("div",be,[N((r(),l("div",xe,[u(C,{type:"button",onClick:o.toggleSearch,variant:"soft-success",size:"sm"},{default:c(()=>t[5]||(t[5]=[e("i",{class:"ri-add-line align-bottom"},null,-1)])),_:1,__:[5]},8,["onClick"])])),[[q,void 0,void 0,{hover:!0}]])])),o.userSearch?(r(),l("div",ke,[e("div",Ce,[N(e("input",{type:"text",class:"form-control bg-light border-light",placeholder:"Search users...",id:"searchMessage","onUpdate:modelValue":t[0]||(t[0]=s=>o.searchQuery=s),onInput:t[1]||(t[1]=(...s)=>o.onSearch&&o.onSearch(...s))},null,544),[[G,o.searchQuery]]),t[7]||(t[7]=e("i",{class:"ri-search-2-line search-icon"},null,-1))])])):k("",!0)])]),o.userSearch?(r(),V(j,{key:0,class:"chat-room-list","data-simplebar":""},{default:c(()=>[e("div",Be,[e("div",Se,[e("h4",De,_(b.$t("users")),1)])]),e("div",Te,[e("div",je,[(r(!0),l(Y,null,A(o.users,(s,S)=>(r(),l("li",{class:"",key:s.id,onClick:F=>o.createChat(s)},[u(w,{href:"javascript: void(0);"},{default:c(()=>[e("div",Ie,[e("div",Le,[s.profile_picture?(r(),l("div",Ee,[e("img",{src:`${s.profile_picture}`,class:"rounded-circle img-fluid userprofile avatar-xs",alt:""},null,8,qe)])):k("",!0),s.profile_picture?k("",!0):(r(),l("div",He,[e("div",Ve,_(s.profile_picture),1)]))]),e("div",Ne,[e("p",Re,_(s.name),1),e("p",Ue,_(s.role_name),1)])])]),_:2},1024)],8,Me))),128))])])]),_:1})):(r(),V(j,{key:1,class:"chat-room-list","data-simplebar":""},{default:c(()=>[e("div",ze,[e("div",Ae,[e("h4",Ye,_(b.$t("direct_messages")),1)])]),e("div",Qe,[e("div",Fe,[(r(!0),l(Y,null,A(o.conversationsData,s=>(r(),l("li",{class:Q(["",{active:o.selectedConversationId===s.id}]),key:s.id,onClick:S=>o.selectConversation(s.id)},[u(w,{href:"javascript: void(0);"},{default:c(()=>[e("div",Ge,[e("div",Je,[s.profile_picture?(r(),l("div",We,[e("img",{src:`${s.profile_picture}`,class:"rounded-circle img-fluid userprofile avatar-xs",alt:""},null,8,Ze)])):k("",!0),s.profile_picture?k("",!0):(r(),l("div",Ke,[e("div",Pe,_(s.profile_picture),1)]))]),e("div",Xe,[e("p",$e,_(s.subject),1),e("p",es,_(s.role),1)]),e("div",ss,[s.unread>0?(r(),l("span",ts,_(s.unread),1)):k("",!0)]),e("div",os,[s.unread>0?(r(),V(B,{key:0,variant:"dark-subtle",class:"bg-dark-subtle text-body rounded p-1"},{default:c(()=>[J(_(s.last_seen??o.convertedTime(s.last_message_time)),1)]),_:2},1024)):k("",!0)])])]),_:2},1024)],10,Oe))),128))])])]),_:1}))]),e("div",as,[e("div",is,[e("div",ns,[o.selectedConversationId?(r(),l("div",rs,[e("div",ls,[u(f,{class:"align-items-center"},{default:c(()=>[u(x,{sm:"4",cols:"8"},{default:c(()=>[e("div",cs,[e("div",ds,[u(w,{href:"javascript: void(0);",class:"user-chat-remove fs-18 p-1"},{default:c(()=>t[8]||(t[8]=[e("i",{class:"ri-arrow-left-s-line align-bottom"},null,-1)])),_:1,__:[8]})]),e("div",us,[e("div",_s,[e("div",ms,[e("img",{src:o.profile?o.profile:require("@/assets/images/users/user-dummy-img.jpg"),class:"rounded-circle avatar-xs",alt:""},null,8,hs),t[9]||(t[9]=e("span",{class:"user-status"},null,-1))]),e("div",vs,[e("h5",fs,[u(w,{class:"text-reset username"},{default:c(()=>[J(_(o.username),1)]),_:1})])])])])])]),_:1}),u(x,{sm:"8",cols:"4"},{default:c(()=>[e("ul",gs,[e("li",ps,[u(M,{variant:"link",class:"btn btn-ghost-secondary btn-icon","toggle-class":" arrow-none","menu-class":"dropdown-menu","aria-haspopup":"true"},{"button-content":c(()=>t[10]||(t[10]=[e("i",{class:"ri-settings-2-fill"},null,-1)])),default:c(()=>[u(E,null,{default:c(()=>[t[11]||(t[11]=e("i",{class:"ri-mail-close-fill align-bottom text-danger me-2"},null,-1)),e("span",{class:"text-danger",id:"sa-params",onClick:t[2]||(t[2]=(...s)=>o.cancel&&o.cancel(...s))},"Close Chat")]),_:1,__:[11]})]),_:1})])])]),_:1})]),_:1})]),e("div",bs,[u(j,{class:"chat-conversation p-3 p-lg-4",id:"chat-conversation","data-simplebar":"",ref:"current"},{default:c(()=>[e("ul",xs,[(r(!0),l(Y,null,A(o.messagesData,s=>(r(),l("li",{key:s.id,class:Q(["chat-list",s.align])},[e("div",ys,[s.align!=="right"?(r(),l("div",ws,[e("img",{src:s.profile_picture,alt:""},null,8,ks)])):k("",!0),e("div",Cs,[e("div",Bs,[e("div",Ss,[e("p",Ds,_(s.message),1)])]),e("div",Ts,[e("small",js,_(s.time),1),t[12]||(t[12]=e("span",{class:"text-success"},[e("i",{class:"bx bx-check"})],-1))])])])],2))),128))])]),_:1},512)]),e("div",Ms,[e("form",{onSubmit:t[4]||(t[4]=re((...s)=>o.formSubmit&&o.formSubmit(...s),["prevent"]))},[u(f,{class:"g-0 align-items-center"},{default:c(()=>[u(x,null,{default:c(()=>[N(e("input",{disabled:o.isSubmitting,"onUpdate:modelValue":t[3]||(t[3]=s=>o.form.message=s),class:Q([{"is-invalid":o.v$.form.message.$invalid},"form-control chat-input bg-light border-light"]),type:"text",placeholder:b.$t("enter_message")},null,10,Is),[[G,o.form.message]])]),_:1}),u(x,{cols:"auto"},{default:c(()=>[e("div",Ls,[e("div",Es,[u(C,{disabled:o.isSubmitting,variant:"success",type:"submit",class:"chat-send"},{default:c(()=>[o.isSubmitting?(r(),l("span",Hs)):(r(),l("i",qs))]),_:1},8,["disabled"])])])]),_:1})]),_:1})],32)])])):(r(),l("div",Vs))])])])])]),_:1})}const Ys=X(de,[["render",Ns]]);export{Ys as default};
